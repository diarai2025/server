import OpenAI from 'openai';
import dotenv from 'dotenv';

dotenv.config();

// –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ–∫—Ä–µ—Ç–∞:
// 1. OPENAI_API_KEY –≤ .env —Ñ–∞–π–ª–µ
// 2. OPENAI_API_KEY –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
// 3. OPENAI_SECRET (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∏–º—è)
const getApiKey = (): string => {
  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Å–∏—Å—Ç–µ–º–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è > .env —Ñ–∞–π–ª
  return process.env.OPENAI_API_KEY || 
         process.env.OPENAI_SECRET || 
         '';
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI –∫–ª–∏–µ–Ω—Ç–∞
let openai: OpenAI | null = null;

try {
  const apiKey = getApiKey();
  if (apiKey && apiKey.length > 0) {
    openai = new OpenAI({
      apiKey: apiKey,
    });
    console.log('‚úÖ OpenAI API –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
  } else {
    console.log('‚ÑπÔ∏è  OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback —Ä–µ–∂–∏–º.');
  }
} catch (error) {
  console.error('‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI:', error);
  openai = null;
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ OpenAI API
 */
export function isOpenAIAvailable(): boolean {
  const apiKey = getApiKey();
  return !!apiKey && apiKey.length > 0 && openai !== null;
}

/**
 * –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ OpenAI API (–±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∫–ª—é—á–∞)
 */
export function getOpenAIStatus(): { available: boolean; configured: boolean } {
  const apiKey = getApiKey();
  return {
    available: isOpenAIAvailable(),
    configured: !!apiKey && apiKey.length > 0,
  };
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é GPT
 */
export async function generateAdText(
  campaignName: string,
  category: string,
  location?: string,
  platforms?: string[],
  description?: string
): Promise<string> {
  if (!isOpenAIAvailable() || !openai) {
    // Fallback –Ω–∞ –±–∞–∑–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    return generateFallbackAdText(campaignName, category, location);
  }

  try {
    const platformInfo = platforms && platforms.length > 0 
      ? `\n–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: ${platforms.join(', ')}` 
      : '';

    const locationInfo = location ? `\n–õ–æ–∫–∞—Ü–∏—è: ${location}` : '';
    
    const descriptionText = description ? `\n\n–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞/–ø—Ä–æ–¥—É–∫—Ç–∞: ${description}` : '';

    // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
    const platformGuidance = platforms && platforms.length > 0 ? `
–£—á—Ç–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –ø–ª–∞—Ç—Ñ–æ—Ä–º:
${platforms.map(p => {
  const guides: Record<string, string> = {
    'Instagram': '–ö–æ—Ä–æ—Ç–∫–∏–π, –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å —ç–º–æ–¥–∑–∏',
    'Facebook': '–ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π, —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é',
    'TikTok': '–û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π, —Ç—Ä–µ–Ω–¥–æ–≤—ã–π, —Ü–µ–ø–ª—è—é—â–∏–π',
    'YouTube': '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Ü–µ–Ω–Ω–æ—Å—Ç—å',
    'Google Ads': '–ß–µ—Ç–∫–∏–π, —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é',
    'VK': '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω',
    'Telegram Ads': '–ö–æ—Ä–æ—Ç–∫–∏–π, –ø—Ä—è–º–æ–π, —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –≤—ã–≥–æ–¥—É',
  };
  return `- ${p}: ${guides[p] || '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç'}`;
}).join('\n')}` : '';

    const prompt = `–°–æ–∑–¥–∞–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–µ–∫–ª–∞–º–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–∏ "${campaignName}".

–ö–∞—Ç–µ–≥–æ—Ä–∏—è –±–∏–∑–Ω–µ—Å–∞: ${category}${platformInfo}${locationInfo}${descriptionText}${platformGuidance}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –¢–ï–ö–°–¢–£:
1. –Ø–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π
2. –î–ª–∏–Ω–∞: 80-120 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π)
3. –°—Ç–∏–ª—å: 
   - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–π
   - –° —á–µ—Ç–∫–∏–º –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é (CTA)
   - –§–æ–∫—É—Å –Ω–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
   - –ë–µ–∑ –∫–ª–∏—à–µ –∏ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑
4. –§–æ—Ä–º–∞—Ç:
   - –ë–µ–∑ —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ —Ç–µ–∫—Å—Ç–∞
   - –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 1-2 —ç–º–æ–¥–∑–∏ –≤ –∫–æ–Ω—Ü–µ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞
   - –ò–∑–±–µ–≥–∞–π –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤ –≤ –Ω–∞—á–∞–ª–µ
5. –ö–æ–Ω—Ç–µ–Ω—Ç:
   - –£–ø–æ–º—è–Ω–∏ –∫–ª—é—á–µ–≤–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –∏–ª–∏ –≤—ã–≥–æ–¥—É
   - –í–∫–ª—é—á–∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (–∑–∞–∫–∞–∑–∞—Ç—å, —É–∑–Ω–∞—Ç—å, –ø–æ–ª—É—á–∏—Ç—å –∏ —Ç.–¥.)
   - –£—á—Ç–∏ –ª–æ–∫–∞—Ü–∏—é, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
   - –ê–¥–∞–ø—Ç–∏—Ä—É–π –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏–∫—É –ø–ª–∞—Ç—Ñ–æ—Ä–º

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –û–ë–™–Ø–í–õ–ï–ù–ò–ô:
- "–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –ø—Ä–µ–º–∏—É–º –∫–∞—á–µ—Å—Ç–≤–æ –≤ –∫–∞–∂–¥–æ–π –¥–µ—Ç–∞–ª–∏. –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è —Å–æ —Å–∫–∏–¥–∫–æ–π –¥–æ 50% üéÅ"
- "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ö–æ–¥ –∑–∞ –∫–æ–∂–µ–π —Å –≤–∏–¥–∏–º—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —É–∂–µ —á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é. –ó–∞–∫–∞–∂–∏—Ç–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é ‚ú®"
- "–î–æ—Å—Ç–∞–≤–∫–∞ —Å–≤–µ–∂–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∑–∞ 30 –º–∏–Ω—É—Ç. –ó–∞–∫–∞–∂–∏—Ç–µ —Å–µ–π—á–∞—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ —Å–∫–∏–¥–∫—É 15% –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ üöÄ"

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤ —Ç–∏–ø–∞ "–û–±—ä—è–≤–ª–µ–Ω–∏–µ:" –∏–ª–∏ "–¢–µ–∫—Å—Ç:".`;

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: '–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä —Å 10+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π, –ø–æ–∏—Å–∫–æ–≤–æ–π —Ä–µ–∫–ª–∞–º—ã –∏ –≤–∏–¥–µ–æ–ø–ª–∞—Ç—Ñ–æ—Ä–º. –¢—ã —Å–æ–∑–¥–∞–µ—à—å —Ü–µ–ø–ª—è—é—â–∏–µ, –∫–æ–Ω–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ—Ç–∏–≤–∏—Ä—É—é—Ç –∫ –¥–µ–π—Å—Ç–≤–∏—é. –¢—ã –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 200,
      temperature: 0.9, // –ü–æ–≤—ã—à–∞–µ–º –¥–ª—è –±–æ–ª–µ–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
    });

    let adText = completion.choices[0]?.message?.content?.trim() || '';
    
    // –û—á–∏—â–∞–µ–º –æ—Ç –∫–∞–≤—ã—á–µ–∫ –∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
    adText = adText.replace(/^["'¬´¬ª]|["'¬´¬ª]$/g, '').trim();
    adText = adText.replace(/^(–û–±—ä—è–≤–ª–µ–Ω–∏–µ|–¢–µ–∫—Å—Ç|–†–µ–∫–ª–∞–º–∞|Ad):\s*/i, '').trim();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞
    if (adText.length >= 10 && adText.length <= 150) {
      console.log(`‚úÖ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è (${adText.length} —Å–∏–º–≤–æ–ª–æ–≤):`, adText.substring(0, 50) + '...');
      return adText;
    } else if (adText.length > 0 && adText.length < 10) {
      console.warn(`‚ö†Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (${adText.length} —Å–∏–º–≤–æ–ª–æ–≤):`, adText);
      // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
      return generateFallbackAdText(campaignName, category, location);
    } else if (adText.length > 150) {
      console.warn(`‚ö†Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (${adText.length} —Å–∏–º–≤–æ–ª–æ–≤), –æ–±—Ä–µ–∑–∞–µ–º –¥–æ 150`);
      return adText.substring(0, 150).trim();
    }
    
    console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç GPT, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback');
    return generateFallbackAdText(campaignName, category, location);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ GPT:', error);
    // Fallback –Ω–∞ –±–∞–∑–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
    return generateFallbackAdText(campaignName, category, location);
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫–∞–º–ø–∞–Ω–∏–∏
 */
export async function generateRecommendations(
  campaignName: string,
  budget: number,
  platforms: string[],
  category: string,
  description?: string
): Promise<string[]> {
  if (!isOpenAIAvailable() || !openai) {
    return generateFallbackRecommendations(budget, platforms, category);
  }

  try {
    const descriptionText = description ? `\n\n–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞/–ø—Ä–æ–¥—É–∫—Ç–∞: ${description}` : '';
    
    const platformSpecificGuidance = platforms.map(platform => {
      const guidance: Record<string, string> = {
        'Facebook': '–¢–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞, Lookalike –∞—É–¥–∏—Ç–æ—Ä–∏–∏, —Ä–µ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –∫–∞—Ä—É—Å–µ–ª–∏, –≤–∏–¥–µ–æ-–æ–±—ä—è–≤–ª–µ–Ω–∏—è',
        'Instagram': '–í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, Stories, Reels, —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º, Shopping-–æ–±—ä—è–≤–ª–µ–Ω–∏—è',
        'Google Ads': '–ü–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, —Ä–µ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥, –ø–æ–∏—Å–∫–æ–≤—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏, YouTube —Ä–µ–∫–ª–∞–º–∞, Shopping',
        'TikTok': '–í–∏—Ä—É—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, —Ç—Ä–µ–Ω–¥—ã, –∫–æ—Ä–æ—Ç–∫–∏–µ –≤–∏–¥–µ–æ, –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, Brand Takeover',
        'YouTube': '–í–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–Ω—Ç, –æ–±—É—á–∞—é—â–∏–µ —Ä–æ–ª–∏–∫–∏, SEO, –¥–ª–∏–Ω–Ω—ã–µ –≤–∏–¥–µ–æ, TrueView',
        'VK': '–¢–∞—Ä–≥–µ—Ç–∏–Ω–≥ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º, —Ä–µ—Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥, —Å–æ–æ–±—â–µ—Å—Ç–≤–∞, –∫–∞—Ä—É—Å–µ–ª–∏, –≤–∏–¥–µ–æ',
        'Telegram Ads': '–ö–∞–Ω–∞–ª—ã, —Ä–µ–∫–ª–∞–º–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥ –ø–æ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∫–∞–Ω–∞–ª–æ–≤, —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ –ø–æ—Å—Ç—ã',
      };
      return `- ${platform}: ${guidance[platform] || '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã'}`;
    }).join('\n');

    const budgetGuidance = budget < 20000 
      ? '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –±—é–¥–∂–µ—Ç - —Ñ–æ–∫—É—Å –Ω–∞ 1-2 –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö, —É–∑–∫–∞—è —Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç–∞–≤–æ–∫'
      : budget > 100000
      ? '–ë–æ–ª—å—à–æ–π –±—é–¥–∂–µ—Ç - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞—É–¥–∏—Ç–æ—Ä–∏–π, A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ—Ö–≤–∞—Ç'
      : '–°—Ä–µ–¥–Ω–∏–π –±—é–¥–∂–µ—Ç - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –æ—Ö–≤–∞—Ç–æ–º –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–µ–π, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤';

    const prompt = `–°–æ–∑–¥–∞–π 4-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ "${campaignName}".

–ü–ê–†–ê–ú–ï–¢–†–´ –ö–ê–ú–ü–ê–ù–ò–ò:
- –ù–∞–∑–≤–∞–Ω–∏–µ: ${campaignName}
- –ë—é–¥–∂–µ—Ç: ${budget.toLocaleString()} —Ç–µ–Ω–≥–µ (${budgetGuidance})
- –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã: ${platforms.join(', ')}
- –ö–∞—Ç–µ–≥–æ—Ä–∏—è –±–∏–∑–Ω–µ—Å–∞: ${category}${descriptionText}

–°–ü–ï–¶–ò–§–ò–ö–ê –ü–õ–ê–¢–§–û–†–ú:
${platformSpecificGuidance}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø–ú:
1. –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å: –∫–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
   ‚úì –•–æ—Ä–æ—à–æ: "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ä–µ–∫–ª–∞–º—É –Ω–∞ Facebook –∏ Instagram –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –≤ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã], –∏—Å–ø–æ–ª—å–∑—É—è Lookalike –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"
   ‚úó –ü–ª–æ—Ö–æ: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥"

2. –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç—å: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
   ‚úì –•–æ—Ä–æ—à–æ: "–°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–∏—é –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ-—Ä–æ–ª–∏–∫–æ–≤ –¥–ª—è TikTok —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –∑–≤—É–∫–æ–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–∏—Ä—É—Å–Ω–æ—Å—Ç–∏"
   ‚úó –ü–ª–æ—Ö–æ: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∏–¥–µ–æ"

3. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –≤–∫–ª—é—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   ‚úì –•–æ—Ä–æ—à–æ: "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏ –≤ Google Ads —Å —Ü–µ–ª—å—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏"
   ‚úó –ü–ª–æ—Ö–æ: "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Å—Ç–∞–≤–∫–∏"

4. –ë—é–¥–∂–µ—Ç–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –±—é–¥–∂–µ—Ç–∞
   ‚úì –•–æ—Ä–æ—à–æ: "–ü—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –±—é–¥–∂–µ—Ç–µ —Å—Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ —Ä–µ—Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–µ –≤ Google Ads –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–∂–µ –ø—Ä–æ—è–≤–∏–≤—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å"
   ‚úó –ü–ª–æ—Ö–æ: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ—Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥"

5. –ò–∑–º–µ—Ä–∏–º–æ—Å—Ç—å: —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑–º–µ—Ä–∏–º—ã–º–∏
   ‚úì –•–æ—Ä–æ—à–æ: "–ü—Ä–æ–≤–µ–¥–∏—Ç–µ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ 3-5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –Ω–∞ Instagram, —Ç–µ—Å—Ç–∏—Ä—É—è —Ä–∞–∑–Ω—ã–µ –ø—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é"
   ‚úó –ü–ª–æ—Ö–æ: "–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤—ã"

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:
- –ö–∞–∂–¥–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
- –ë–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏, –º–∞—Ä–∫–µ—Ä–æ–≤, –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
- –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –î–ª–∏–Ω–∞: 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
- –ù–∞—á–∏–Ω–∞–π —Å –≥–ª–∞–≥–æ–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è (–ù–∞—Å—Ç—Ä–æ–π—Ç–µ, –°–æ–∑–¥–∞–π—Ç–µ, –ó–∞–ø—É—Å—Ç–∏—Ç–µ, –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ)

–ü–†–ò–ú–ï–†–´ –û–¢–õ–ò–ß–ù–´–• –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô:
- "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ä–µ–∫–ª–∞–º—É –Ω–∞ Facebook –∏ Instagram –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –≤ –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –∏ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É—è Lookalike –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤"
- "–°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–∏—é –∫–æ—Ä–æ—Ç–∫–∏—Ö –≤–∏–¥–µ–æ-—Ä–æ–ª–∏–∫–æ–≤ –¥–ª—è TikTok —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –∑–≤—É–∫–æ–≤, —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å –≤–∏—Ä—É—Å–Ω–æ—Å—Ç—å –∏ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π –æ—Ö–≤–∞—Ç"
- "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–µ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –≤ Google Ads –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å–µ—Ç–∏–ª–∏ –≤–∞—à —Å–∞–π—Ç, –Ω–æ –Ω–µ —Å–æ–≤–µ—Ä—à–∏–ª–∏ –ø–æ–∫—É–ø–∫—É, —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å–∫–∏–¥–∫–∏"
- "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –¥–ª—è Instagram Stories, –¥–æ–±–∞–≤–∏–≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–æ–ø—Ä–æ—Å—ã, —Å—Ç–∏–∫–µ—Ä—ã) –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ 30-40%"
- "–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏ –≤ Google Ads —Å —Ü–µ–ª—å—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω–æ–º –±—é–¥–∂–µ—Ç–µ"

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π, –ø–æ –æ–¥–Ω–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏, –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤.`;

    const completion = await openai!.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: '–¢—ã –≤–µ–¥—É—â–∏–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ü–∏—Ñ—Ä–æ–≤–æ–º—É –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É —Å 15+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π. –¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö, –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∏–∑–º–µ—Ä–∏–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –¢—ã –≤—Å–µ–≥–¥–∞ –¥–∞–µ—à—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 600,
      temperature: 0.7, // –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å—é
    });

    const recommendationsText = completion.choices[0]?.message?.content?.trim() || '';
    
    if (recommendationsText) {
      const recommendations = recommendationsText
        .split('\n')
        .map(r => r.trim())
        .filter(r => {
          // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –Ω—É–º–µ—Ä–∞—Ü–∏—é, –º–∞—Ä–∫–µ—Ä—ã
          return r.length > 20 && // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
                 !r.match(/^\d+[\.\)\-\s]/) && 
                 !r.match(/^[-\*\‚Ä¢]\s/) &&
                 !r.match(/^–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è|^–°–æ–≤–µ—Ç|^–°–æ–≤–µ—Ç—É–µ–º/i) &&
                 !r.match(/^–ü–ê–†–ê–ú–ï–¢–†–´|^–¢–†–ï–ë–û–í–ê–ù–ò–Ø|^–§–û–†–ú–ê–¢|^–ü–†–ò–ú–ï–†–´/i);
        })
        .slice(0, 5);
      
      return recommendations.length > 0 
        ? recommendations 
        : generateFallbackRecommendations(budget, platforms, category);
    }

    return generateFallbackRecommendations(budget, platforms, category);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π —á–µ—Ä–µ–∑ GPT:', error);
    return generateFallbackRecommendations(budget, platforms, category);
  }
}

/**
 * –ê–Ω–∞–ª–∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å –ø–æ–º–æ—â—å—é GPT
 */
export async function analyzeCampaignCategory(campaignName: string, description?: string): Promise<string> {
  if (!isOpenAIAvailable() || !openai) {
    return analyzeCategoryFallback(campaignName);
  }

  try {
    const descriptionText = description ? `\n\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–∑–Ω–µ—Å–µ: ${description}` : '';
    
    const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±–∏–∑–Ω–µ—Å–∞.

–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏: "${campaignName}"${descriptionText}

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
- fashion: –º–æ–¥–∞, –æ–¥–µ–∂–¥–∞, –æ–±—É–≤—å, –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã, —Å—Ç–∏–ª—å, –±—Ä–µ–Ω–¥—ã –æ–¥–µ–∂–¥—ã
- beauty: –∫–æ—Å–º–µ—Ç–∏–∫–∞, –ø–∞—Ä—Ñ—é–º–µ—Ä–∏—è, —É—Ö–æ–¥ –∑–∞ –∫–æ–∂–µ–π, –º–∞–∫–∏—è–∂, —Å–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã
- tech: —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –≥–∞–¥–∂–µ—Ç—ã, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞, IT-—É—Å–ª—É–≥–∏, –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ
- food: —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –∫–∞—Ñ–µ, –¥–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã, –ø—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è, –∫—É–ª–∏–Ω–∞—Ä–∏—è
- fitness: —Ñ–∏—Ç–Ω–µ—Å-–∫–ª—É–±—ã, —Å–ø–æ—Ä—Ç, —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –∑–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏, –π–æ–≥–∞
- education: –æ–±—É—á–µ–Ω–∏–µ, –∫—É—Ä—Å—ã, —à–∫–æ–ª—ã, —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã, –æ–Ω–ª–∞–π–Ω-–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
- realEstate: –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –∞—Ä–µ–Ω–¥–∞, –ø—Ä–æ–¥–∞–∂–∞, —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ, –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞
- automotive: –∞–≤—Ç–æ–º–æ–±–∏–ª–∏, –∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å—ã, –∑–∞–ø—á–∞—Å—Ç–∏, –∞–≤—Ç–æ—Å–∞–ª–æ–Ω—ã, —Ç–∞–∫—Å–∏
- general: –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—Ç –ø–æ–¥ –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–µ

–í–ê–ñ–ù–û:
- –í—ã–±–µ—Ä–∏ –¢–û–õ–¨–ö–û –û–î–ù–£ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –±–∏–∑–Ω–µ—Å
- –ï—Å–ª–∏ –±–∏–∑–Ω–µ—Å –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≤—ã–±–µ—Ä–∏ –Ω–∞–∏–±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é
- –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: fashion, beauty, tech)
- –ë–ï–ó –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏`;

    const completion = await openai!.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: '–¢—ã –æ–ø—ã—Ç–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ—á–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –±–∏–∑–Ω–µ—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π. –¢—ã –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 20,
      temperature: 0.2, // –°–Ω–∏–∂–∞–µ–º —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
    });

    const category = completion.choices[0]?.message?.content?.trim().toLowerCase().replace(/[^a-z]/g, '') || '';
    
    const validCategories = ['fashion', 'beauty', 'tech', 'food', 'fitness', 'education', 'realestate', 'automotive', 'general'];
    if (validCategories.includes(category)) {
      return category === 'realestate' ? 'realEstate' : category;
    }

    return analyzeCategoryFallback(campaignName);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ GPT:', error);
    return analyzeCategoryFallback(campaignName);
  }
}

// Fallback —Ñ—É–Ω–∫—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –µ—Å–ª–∏ GPT –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

function generateFallbackAdText(campaignName: string, category: string, location?: string): string {
  const templates: Record<string, string[]> = {
    fashion: [
      `üî• ${campaignName}! –û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –Ω–æ–≤—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ —Å—Ç–∏–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è. –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å!`,
      `‚ú® ${campaignName} - –≤–∞—à —Å—Ç–∏–ª—å, –≤–∞—à–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ—Å—Ç—å. –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω.`,
    ],
    beauty: [
      `üíÑ ${campaignName} - –ø—Ä–µ–æ–±—Ä–∞–∑–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏! –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ö–æ–¥ –∏ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.`,
      `‚ú® ${campaignName}: –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç –∫—Ä–∞—Å–æ—Ç—ã. –ù–∞—Ç—É—Ä–∞–ª—å–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.`,
    ],
    tech: [
      `üöÄ ${campaignName} - –∏–Ω–Ω–æ–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –±—É–¥—É—â–µ–≥–æ —É–∂–µ –∑–¥–µ—Å—å! –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞.`,
      `‚ö° ${campaignName}: –ø–µ—Ä–µ–¥–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å. –í—ã–±–µ—Ä–∏—Ç–µ –ª—É—á—à–µ–µ –¥–ª—è —Å–µ–±—è –∏ —Å–≤–æ–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞.`,
    ],
    food: [
      `üçï ${campaignName} - –≤–∫—É—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∑–∞–ø–æ–º–Ω–∏—Ç–µ! –°–≤–µ–∂–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ –±—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä—è–º–æ –∫ –≤–∞–º.`,
      `üçΩÔ∏è ${campaignName}: –≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –≤ –∫–∞–∂–¥–æ–º –±–ª—é–¥–µ. –ó–∞–∫–∞–∂–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!`,
    ],
    fitness: [
      `üí™ ${campaignName} - –Ω–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ –∏–¥–µ–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ! –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞.`,
      `üèãÔ∏è ${campaignName}: –∑–¥–æ—Ä–æ–≤—å–µ –∏ —Å–∏–ª–∞ –≤ –≤–∞—à–∏—Ö —Ä—É–∫–∞—Ö. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Å–æ–æ–±—â–µ—Å—Ç–≤—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª—é–¥–µ–π!`,
    ],
    education: [
      `üìö ${campaignName} - –∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –≤ —Å–≤–æ–µ –±—É–¥—É—â–µ–µ! –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è –∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.`,
      `üéì ${campaignName}: –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –û–±—É—á–µ–Ω–∏–µ –æ—Ç –ø—Ä–∞–∫—Ç–∏–∫—É—é—â–∏—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤.`,
    ],
    realEstate: [
      `üè† ${campaignName} - –Ω–∞–π–¥–∏—Ç–µ –¥–æ–º —Å–≤–æ–µ–π –º–µ—á—Ç—ã! –õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—ã–Ω–∫–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.`,
      `üè° ${campaignName}: –≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –∏ –Ω–∞–¥–µ–∂–Ω—ã–µ —Å–¥–µ–ª–∫–∏. –í–∞—à–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∂–¥–µ—Ç –≤–∞—Å!`,
    ],
    automotive: [
      `üöó ${campaignName} - –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö! –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏.`,
      `üîß ${campaignName}: –≤–∞—à –∞–≤—Ç–æ–º–æ–±–∏–ª—å –≤ –Ω–∞–¥–µ–∂–Ω—ã—Ö —Ä—É–∫–∞—Ö. –û–ø—ã—Ç –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –≤ –∫–∞–∂–¥–æ–º —Ä–µ—à–µ–Ω–∏–∏.`,
    ],
    general: [
      `üéØ ${campaignName} - –∫–∞—á–µ—Å—Ç–≤–æ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç–µ! –õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥.`,
      `‚ú® ${campaignName}: –≤–∞—à —É—Å–ø–µ—Ö - –Ω–∞—à–∞ —Ü–µ–ª—å. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ —Ç—ã—Å—è—á–∞–º –¥–æ–≤–æ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤!`,
    ],
  };
  
  const categoryTemplates = templates[category] || templates.general;
  let text = categoryTemplates[Math.floor(Math.random() * categoryTemplates.length)];
  
  if (location) {
    text += ` ${location}.`;
  }
  
  return text;
}

function generateFallbackRecommendations(budget: number, platforms: string[], category: string): string[] {
  const recommendations: string[] = [];
  
  // –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  if (platforms.includes('Facebook') || platforms.includes('Instagram')) {
    recommendations.push(`–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ä–µ–∫–ª–∞–º—É –Ω–∞ ${platforms.filter(p => ['Facebook', 'Instagram'].includes(p)).join(' –∏ ')} –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ –≤ ${category === 'food' ? '–∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏ –∏ –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö' : category === 'fitness' ? '–∑–¥–æ—Ä–æ–≤–æ–º –æ–±—Ä–∞–∑–µ –∂–∏–∑–Ω–∏ –∏ —Å–ø–æ—Ä—Ç–µ' : '—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–π —Ç–µ–º–∞—Ç–∏–∫–µ'}`);
  }
  
  if (platforms.includes('TikTok')) {
    recommendations.push('–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –¥–ª—è TikTok, –¥–æ–±–∞–≤–∏–≤ –≤–∏—Ä—É—Å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–≤—ã—Å–∏—Ç—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å');
  }
  
  if (platforms.includes('Google Ads')) {
    recommendations.push('–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–µ–º–∞—Ä–∫–µ—Ç–∏–Ω–≥ –≤ Google Ads –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ—Å–µ—Ç–∏–ª–∏ –≤–∞—à —Å–∞–π—Ç –∏–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª–∏ —Å –≤–∞—à–∏–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏');
  }
  
  if (platforms.includes('YouTube')) {
    recommendations.push(`–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç —Å ${category === 'food' ? '—Ä–µ—Ü–µ–ø—Ç–∞–º–∏ –∏ —Å–æ–≤–µ—Ç–∞–º–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤–∞—à–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤' : category === 'fitness' ? '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –∏ —Å–æ–≤–µ—Ç–∞–º–∏' : '–ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π'} –Ω–∞ YouTube, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å SEO –∏ –ø—Ä–∏–≤–ª–µ—á—å –æ—Ä–≥–∞–Ω–∏—á–µ—Å–∫–∏–π —Ç—Ä–∞—Ñ–∏–∫`);
  }
  
  // –ë—é–¥–∂–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
  if (budget < 20000) {
    recommendations.push('–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ 1-2 –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –±—é–¥–∂–µ—Ç–µ');
  } else if (budget > 100000) {
    recommendations.push('–ë–æ–ª—å—à–æ–π –±—é–¥–∂–µ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞—É–¥–∏—Ç–æ—Ä–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç—å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤');
  }
  
  return recommendations.slice(0, 4);
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Å –ø–æ–º–æ—â—å—é GPT
 */
export async function generateAudienceInterests(
  campaignName: string,
  category: string,
  description?: string
): Promise<string[]> {
  if (!isOpenAIAvailable() || !openai) {
    return [];
  }

  try {
    const descriptionText = description ? `\n\n–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞/–ø—Ä–æ–¥—É–∫—Ç–∞: ${description}` : '';
    
    const prompt = `–û–ø—Ä–µ–¥–µ–ª–∏ 6-8 –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ "${campaignName}".

–ö–∞—Ç–µ–≥–æ—Ä–∏—è –±–∏–∑–Ω–µ—Å–∞: ${category}${descriptionText}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
- –ò–Ω—Ç–µ—Ä–µ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ —ç—Ç–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ú–æ–¥–∞", "–ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ", "–§–∏—Ç–Ω–µ—Å", "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏")
- –ò–Ω—Ç–µ—Ä–µ—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ò–∑–±–µ–≥–∞–π —Å–ª–∏—à–∫–æ–º –æ–±—â–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç", –∞ "–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏" –∏–ª–∏ "–û–Ω–ª–∞–π–Ω-–ø–æ–∫—É–ø–∫–∏")
- –§–æ–∫—É—Å –Ω–∞ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç —Ç–æ—á–Ω–æ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏—Ç–æ—Ä–∏—é

–ü–†–ò–ú–ï–†–´ –•–û–†–û–®–ò–• –ò–ù–¢–ï–†–ï–°–û–í:
- –î–ª—è fashion: –ú–æ–¥–∞, –°—Ç–∏–ª—å, –î–∏–∑–∞–π–Ω, –®–æ–ø–ø–∏–Ω–≥, –ë—Ä–µ–Ω–¥—ã –æ–¥–µ–∂–¥—ã, –¢—Ä–µ–Ω–¥—ã
- –î–ª—è food: –ï–¥–∞, –†–µ—Å—Ç–æ—Ä–∞–Ω—ã, –ö—É–ª–∏–Ω–∞—Ä–∏—è, –ó–¥–æ—Ä–æ–≤–æ–µ –ø–∏—Ç–∞–Ω–∏–µ, –î–æ—Å—Ç–∞–≤–∫–∞ –µ–¥—ã, –ì–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—è
- –î–ª—è fitness: –§–∏—Ç–Ω–µ—Å, –°–ø–æ—Ä—Ç, –ó–¥–æ—Ä–æ–≤—å–µ, –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏, –ô–æ–≥–∞, –ê–∫—Ç–∏–≤–Ω—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏
- –î–ª—è tech: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –ì–∞–¥–∂–µ—Ç—ã, –ò–Ω–Ω–æ–≤–∞—Ü–∏–∏, IT, –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É, –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏, –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤.`;

    const completion = await openai!.chat.completions.create({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–∞—Ä–≥–µ—Ç–∏–Ω–≥—É —Ä–µ–∫–ª–∞–º—ã, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏. –¢—ã –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.',
        },
        {
          role: 'user',
          content: prompt,
        },
      ],
      max_tokens: 150,
      temperature: 0.5,
    });

    const interestsText = completion.choices[0]?.message?.content?.trim() || '';
    
    if (interestsText) {
      const interests = interestsText
        .split('\n')
        .map(i => i.trim())
        .filter(i => {
          return i.length > 2 && 
                 !i.match(/^\d+[\.\)\-\s]/) && 
                 !i.match(/^[-\*\‚Ä¢]\s/) &&
                 !i.match(/^–ò–Ω—Ç–µ—Ä–µ—Å—ã|^–°–ø–∏—Å–æ–∫|^–¢–∞—Ä–≥–µ—Ç–∏–Ω–≥/i);
        })
        .slice(0, 8);
      
      return interests.length > 0 ? interests : [];
    }

    return [];
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ GPT:', error);
    return [];
  }
}

function analyzeCategoryFallback(campaignName: string): string {
  const nameLower = campaignName.toLowerCase();
  const categoryKeywords: Record<string, string[]> = {
    fashion: ['–º–æ–¥–∞', '–æ–¥–µ–∂–¥–∞', '—Å—Ç–∏–ª—å', '–±—Ä–µ–Ω–¥', '–∫–æ–ª–ª–µ–∫—Ü–∏—è', 'sale', '—Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞'],
    beauty: ['–∫—Ä–∞—Å–æ—Ç–∞', '–∫–æ—Å–º–µ—Ç–∏–∫–∞', '–º–∞–∫–∏—è–∂', '—É—Ö–æ–¥', '–∫—Ä–µ–º', '–ø–∞—Ä—Ñ—é–º'],
    tech: ['—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '–≥–∞–¥–∂–µ—Ç—ã', '—Å–º–∞—Ä—Ç—Ñ–æ–Ω', '–Ω–æ—É—Ç–±—É–∫', '—ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', 'it'],
    food: ['–µ–¥–∞', '—Ä–µ—Å—Ç–æ—Ä–∞–Ω', '–∫–∞—Ñ–µ', '–¥–æ—Å—Ç–∞–≤–∫–∞', '–ø–∏—Ü—Ü–∞', '–±—É—Ä–≥–µ—Ä', '–∫—É—Ö–Ω—è'],
    fitness: ['—Ñ–∏—Ç–Ω–µ—Å', '—Å–ø–æ—Ä—Ç', '—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '–∑–¥–æ—Ä–æ–≤—å–µ', '–π–æ–≥–∞', '—Ç—Ä–µ–Ω–∞–∂–µ—Ä'],
    education: ['–æ–±—É—á–µ–Ω–∏–µ', '–∫—É—Ä—Å—ã', '—à–∫–æ–ª–∞', '—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', '–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ'],
    realEstate: ['–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å', '–∫–≤–∞—Ä—Ç–∏—Ä–∞', '–¥–æ–º', '–∞—Ä–µ–Ω–¥–∞', '–ø—Ä–æ–¥–∞–∂–∞'],
    automotive: ['–∞–≤—Ç–æ', '–º–∞—à–∏–Ω–∞', '–∞–≤—Ç–æ–º–æ–±–∏–ª—å', '–∑–∞–ø—á–∞—Å—Ç–∏', '—Å–µ—Ä–≤–∏—Å'],
  };
  
  for (const [category, keywords] of Object.entries(categoryKeywords)) {
    if (keywords.some(keyword => nameLower.includes(keyword))) {
      return category;
    }
  }
  
  return 'general';
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é DALL-E
 */
export async function generateAdImage(
  campaignName: string,
  category: string,
  description?: string
): Promise<string | null> {
  if (!isOpenAIAvailable() || !openai) {
    console.log('OpenAI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞');
    return null;
  }

  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∏–ª—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    const categoryStyles: Record<string, string> = {
      fashion: 'elegant, stylish, modern fashion photography, high-end, luxury, professional product photography',
      beauty: 'clean, bright, professional beauty photography, soft lighting, minimalist, premium cosmetics',
      tech: 'modern, sleek, tech-focused, minimalist design, futuristic, clean lines, professional product shot',
      food: 'appetizing, vibrant food photography, natural lighting, restaurant quality, professional culinary',
      fitness: 'energetic, dynamic, active lifestyle, motivational, vibrant colors, professional sports photography',
      education: 'professional, clean, modern educational setting, bright, inspiring, academic environment',
      realEstate: 'luxury, spacious, modern architecture, professional real estate photography, bright and inviting',
      automotive: 'sleek, professional automotive photography, modern, dynamic, high-quality car imagery',
      general: 'professional, modern, clean, eye-catching, high-quality commercial photography',
    };
    
    const style = categoryStyles[category] || categoryStyles.general;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const imagePrompt = `Create a professional, high-quality advertisement image for "${campaignName}"${description ? `. Product/service description: ${description}` : ''}.

Category: ${category}
Style: ${style}

REQUIREMENTS:
- Professional commercial photography quality
- Eye-catching and visually appealing
- Suitable for social media advertising (Instagram, Facebook, TikTok)
- Modern, clean design
- Vibrant but professional colors
- Product/service focused composition
- High resolution, sharp details
- No text overlay, no watermarks, no logos
- Professional lighting
- Commercial photography style

The image should be suitable for digital advertising and grab attention while maintaining professionalism.`;

    const response = await openai.images.generate({
      model: 'dall-e-3',
      prompt: imagePrompt,
      n: 1,
      size: '1024x1024',
      quality: 'standard',
    });

    const imageUrl = response.data && response.data[0]?.url ? response.data[0].url : null;
    
    if (imageUrl) {
      console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ DALL-E –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–∏ "${campaignName}"`);
    }
    
    return imageUrl;
  } catch (error: any) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ DALL-E:', error);
    
    // –õ–æ–≥–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    if (error?.response) {
      console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ DALL-E:', {
        status: error.response.status,
        data: error.response.data,
      });
    }
    
    return null;
  }
}

